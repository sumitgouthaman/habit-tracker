rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isValidHabit() {
      let habit = request.resource.data;
      return habit.keys().hasOnly(['id', 'title', 'type', 'targetCount', 'createdAt', 'archived', 'logs', 'increments', 'frequency']) &&
             // String Constraints
             habit.title is string && habit.title.size() > 0 && habit.title.size() <= 60 &&
             habit.type is string && (habit.type == 'daily' || habit.type == 'weekly' || habit.type == 'monthly') &&
             habit.id is string &&
             // Optional Strings
             ( !habit.keys().hasAny(['frequency']) || habit.frequency is string ) &&
             // Optional Arrays
             ( !habit.keys().hasAny(['increments']) || habit.increments is list ) &&
             // Number Constraints
             habit.targetCount is number && habit.targetCount > 0 &&
             // Timestamp Constraints
             habit.createdAt is timestamp &&
             // Boolean Constraints
             habit.archived is bool &&
             // Logs Constraints (New Schema)
             ( !habit.keys().hasAny(['logs']) || habit.logs is map );
    }

    function isAllowedUser() {
      // Allowlist of emails. If empty, all users are allowed.
      let allowedEmails = []; 
      return allowedEmails.size() == 0 || (request.auth.token.email in allowedEmails);
    }

    match /users/{userId} {
      match /habits/{habitId} {
        allow read: if request.auth != null && request.auth.uid == userId && isAllowedUser();
        allow create: if request.auth != null && request.auth.uid == userId && isAllowedUser() && isValidHabit();
        allow update: if request.auth != null && request.auth.uid == userId && isAllowedUser() && isValidHabit();
        allow delete: if request.auth != null && request.auth.uid == userId && isAllowedUser();
      }
    }
  }
}
